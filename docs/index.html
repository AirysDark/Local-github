<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Local-github Builder</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    label { display:block; margin-top:1em; }
    select, input { width: 300px; padding:4px; }
    pre { background:#eee; padding:1em; white-space:pre-wrap; }
  </style>
</head>
<body>
<h1>Local-github Builder</h1>

<form id="builderForm">
  <h2>Build Target</h2>
  <label>Build type:
    <select id="build_type">
      <option value="pi">pi</option>
    </select>
  </label>
  <label>CPU bitrate:
    <select id="cpu_bitrate">
      <option value="64bit">64bit</option>
      <option value="32bit">32bit</option>
    </select>
  </label>

  <h2>User</h2>
  <label>User preset: <select id="user_preset"></select></label>
  <label>Username: <input type="text" id="user_name"></label>
  <label>Password: <input type="password" id="user_password"></label>

  <h2>Wi-Fi</h2>
  <label>Wi-Fi preset: <select id="wifi_preset"></select></label>
  <label>SSID: <input type="text" id="wifi_ssid"></label>
  <label>Password: <input type="password" id="wifi_password"></label>

  <h2>SSH</h2>
  <label>Permit root login:
    <select id="ssh_prl">
      <option value="yes">yes</option>
      <option value="no">no</option>
      <option value="prohibit-password">prohibit-password</option>
    </select>
  </label>
  <label>Password authentication:
    <select id="ssh_pa">
      <option value="yes">yes</option>
      <option value="no">no</option>
    </select>
  </label>
  <label>Pubkey authentication:
    <select id="ssh_pk">
      <option value="yes">yes</option>
      <option value="no">no</option>
    </select>
  </label>

  <h2>Network</h2>
  <label>Static IPv4: <input type="text" id="static_ip" placeholder="192.168.0.8"></label>
  <label>Gateway: <input type="text" id="gateway" placeholder="192.168.0.1"></label>
  <label>DNS servers: <input type="text" id="dns" placeholder="1.1.1.1;8.8.8.8"></label>

  <h2>Region & Locale</h2>
  <label>Wi-Fi country: <select id="wifi_country"></select></label>
  <label>Timezone: <select id="timezone"></select></label>
  <label>Keyboard layout: <select id="keyboard" onchange="toggleKeyboardCustom()"></select></label>
  <label id="keyboard_custom_label" style="display:none">Custom keyboard:
    <input type="text" id="keyboard_custom" placeholder="us,intl">
  </label>

  <br><br>
  <button id="buildBtn">Start Build</button>
</form>

<h2>Workflow Dispatch JSON</h2>
<pre id="jsonOut"></pre>

<h2>cURL Command</h2>
<pre id="curlOut"></pre>

<script>
function targetBitsComputed() {
  return document.getElementById('build_type').value + ' ' + document.getElementById('cpu_bitrate').value;
}
function toggleKeyboardCustom(){
  const kb = document.getElementById('keyboard').value;
  document.getElementById('keyboard_custom_label').style.display = (kb === 'custom') ? 'block' : 'none';
}
function gatherInputs() {
  return {
    target_bits: targetBitsComputed(),
    user_name: document.getElementById('user_name').value,
    user_password: document.getElementById('user_password').value,
    wifi_ssid: document.getElementById('wifi_ssid').value,
    wifi_password: document.getElementById('wifi_password').value,
    ssh_permit_root_login: document.getElementById('ssh_prl').value,
    ssh_password_auth: document.getElementById('ssh_pa').value,
    ssh_pubkey_auth: document.getElementById('ssh_pk').value,
    static_ip: document.getElementById('static_ip').value,
    gateway: document.getElementById('gateway').value,
    dns: document.getElementById('dns').value,
    wifi_country: document.getElementById('wifi_country').value,
    timezone: document.getElementById('timezone').value,
    keyboard: document.getElementById('keyboard').value,
    keyboard_custom: document.getElementById('keyboard_custom').value
  };
}
function showPayload() {
  const body = { ref: "main", inputs: gatherInputs() };
  document.getElementById('jsonOut').textContent = JSON.stringify(body, null, 2);
  const curl = "curl -s -X POST \\\n" +
               "  -H 'Accept: application/vnd.github+json' \\\n" +
               "  -H 'Authorization: Bearer <TOKEN>' \\\n" +
               "  https://api.github.com/repos/OWNER/REPO/actions/workflows/.github/workflows/build.yml/dispatches \\\n" +
               "  -d '" + JSON.stringify(body).replace(/'/g,"'\"'\"'") + "'";
  document.getElementById('curlOut').textContent = curl;
}
document.getElementById('buildBtn').addEventListener('click', (e)=>{ e.preventDefault(); showPayload(); });

function fillSelect(id, arr, labelfn, valuefn, placeholder) {
  const sel = document.getElementById(id);
  sel.innerHTML = "";
  const opt0 = document.createElement('option');
  opt0.value = ""; opt0.textContent = placeholder || "(select)";
  sel.appendChild(opt0);
  arr.forEach((it, idx) => {
    const o = document.createElement('option');
    const label = labelfn ? labelfn(it, idx) : String(it);
    const value = valuefn ? valuefn(it, idx) : String(it);
    o.value = value; o.textContent = label;
    o.dataset.raw = JSON.stringify(it);
    sel.appendChild(o);
  });
}

function onPresetChange(selId, setter){
  const sel = document.getElementById(selId);
  sel.addEventListener('change', ()=>{
    const opt = sel.options[sel.selectedIndex];
    if (!opt || !opt.dataset.raw) return;
    try { setter(JSON.parse(opt.dataset.raw)); } catch(e){}
  });
}

async function loadOptions(){
  try {
    const r = await fetch("config/options.json");
    if(!r.ok) throw new Error("options.json not found");
    const js = await r.json();

    const countries = js.wifi_countries || js.country || [];
    const timezones = js.timezones || js.tz || [];
    const keyboards = js.keyboards || js.kbd || [];
    fillSelect('wifi_country', countries, v=>v, v=>v, '(Wi-Fi country)');
    fillSelect('timezone', timezones, v=>v, v=>v, '(Timezone)');
    fillSelect('keyboard', keyboards, v=>v, v=>v, '(Keyboard)');

    const users = js.users || [];
    const wifis = js.wifi || [];
    fillSelect('user_preset', users, u=>u.name, u=>u.name, '(no user preset)');
    fillSelect('wifi_preset', wifis, w=>w.ssid, w=>w.ssid, '(no Wi-Fi preset)');
    onPresetChange('user_preset', (u)=>{
      document.getElementById('user_name').value = u.name || '';
      document.getElementById('user_password').value = u.password || '';
    });
    onPresetChange('wifi_preset', (w)=>{
      document.getElementById('wifi_ssid').value = w.ssid || '';
      document.getElementById('wifi_password').value = w.password || '';
    });
    if (users.length) { document.getElementById('user_preset').selectedIndex = 1; document.getElementById('user_preset').dispatchEvent(new Event('change')); }
    if (wifis.length) { document.getElementById('wifi_preset').selectedIndex = 1; document.getElementById('wifi_preset').dispatchEvent(new Event('change')); }
  } catch(e) {
    document.getElementById('jsonOut').textContent = 'Could not load config/options.json';
  }
}
loadOptions();
</script>
</body>
</html>