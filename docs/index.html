<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Local-github Builder</title>
<style>
  :root{
    --bg:#0b1118; --panel:#0f1622; --panel-2:#121c2a; --ink:#e6eef8; --muted:#97a8be;
    --brand:#55c2ff; --ok:#67e8a6; --warn:#ffd166; --line:#1a2636; --chip:#0d2136;
    --ring: 0 0 0 2px rgba(85,194,255,.25),0 0 0 6px rgba(85,194,255,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial;
    color:var(--ink); background:radial-gradient(1200px 700px at 80% -10%,#0e1a2b,transparent),
                       radial-gradient(900px 500px at -10% 120%,#0e2338,transparent),
                       var(--bg);
  }
  .wrap{max-width:1100px; margin:28px auto; padding:0 18px;}
  .hero{
    display:flex; align-items:center; justify-content:space-between; gap:16px;
    background:linear-gradient(180deg,rgba(85,194,255,.08),transparent),var(--panel);
    border:1px solid var(--line); border-radius:16px; padding:18px 18px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.03), 0 10px 30px rgba(0,0,0,.25);
  }
  .title{display:flex; align-items:center; gap:12px}
  .logo{
    width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
    background:conic-gradient(from 210deg,#1a6ea7,#55c2ff,#1a6ea7);
    box-shadow:0 6px 18px rgba(85,194,255,.25),inset 0 0 10px rgba(255,255,255,.08);
  }
  .title h1{margin:0; font-weight:700; letter-spacing:.2px}
  .sub{margin:4px 0 0 0; color:var(--muted); font-size:13px}
  .grid{display:grid; gap:16px; grid-template-columns: 1fr 1fr}
  @media (max-width:920px){ .grid{grid-template-columns:1fr} }
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--panel);
    border:1px solid var(--line); border-radius:16px; padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  .card h3{margin:0 0 6px 0; font-size:16px; letter-spacing:.2px}
  .hint{color:var(--muted); font-size:12px; margin-top:6px}
  label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
  input,select{
    width:100%; background:var(--panel-2); color:var(--ink);
    border:1px solid var(--line); border-radius:10px; padding:10px 12px;
    outline:none; transition:.2s border-color, .2s box-shadow;
  }
  input:focus,select:focus{ border-color:var(--brand); box-shadow:var(--ring); }
  .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width:620px){ .row2{grid-template-columns:1fr} }
  .btn{
    display:inline-flex; align-items:center; gap:10px; cursor:pointer;
    background:linear-gradient(180deg,#62d1ff,#55c2ff);
    color:#042032; border:0; border-radius:12px; padding:12px 14px; font-weight:700;
    box-shadow:0 10px 26px rgba(85,194,255,.35), inset 0 1px 0 rgba(255,255,255,.25);
  }
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{
    background:linear-gradient(180deg,#67e8a6,#45d089); color:#072316;
  }
  .out{
    background:var(--panel-2); border:1px solid var(--line); border-radius:12px;
    padding:12px; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    min-height:90px;
  }
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .chip{font-size:12px; padding:6px 8px; border-radius:999px; background:var(--chip); border:1px solid var(--line); color:var(--muted);}
  .kbd{background:#0e2135; border:1px solid #1c314a; padding:2px 6px; border-radius:6px}
  .footer-note{color:var(--muted); font-size:12px; margin-top:6px}
  .status{font-size:13px; color:var(--muted); margin-top:8px}
  .danger{color:#ff8484}
</style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="title">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="#001420">
            <path d="M13 3a9 9 0 1 0 8.485 6H19a7 7 0 1 1-2.05-4.95L15 6h6V0l-2.293 2.293A8.962 8.962 0 0 0 13 3z"/>
          </svg>
        </div>
        <div>
          <h1>Local-github Builder</h1>
          <div class="sub">Build + download your image directly from this page (token is kept in-memory only).</div>
        </div>
      </div>
      <div class="chips">
        <span class="chip">Raspberry Pi</span>
        <span class="chip">Headless</span>
        <span class="chip">Pages → Actions</span>
      </div>
    </div>

    <!-- repo + token -->
    <div class="card" style="margin-top:16px">
      <h3>Repository & token</h3>
      <div class="row2">
        <div>
          <label>Owner</label>
          <input id="owner" placeholder="e.g. your-username">
        </div>
        <div>
          <label>Repo</label>
          <input id="repo" placeholder="e.g. Local-github">
        </div>
      </div>
      <div class="row2">
        <div>
          <label>Workflow path (in repo)</label>
          <input id="workflow_path" value=".github/workflows/build.yml">
        </div>
        <div>
          <label>Branch ref</label>
          <input id="branch_ref" value="main">
        </div>
      </div>
      <label>Personal Access Token (fine-grained; Actions: write, Contents: read)</label>
      <input id="token" type="password" placeholder="ghp_… (NOT stored)">
      <div class="footer-note">Your token is used in requests from your browser to api.github.com and never stored.</div>
    </div>

    <!-- Build target + User -->
    <div class="grid" style="margin-top:16px">
      <div class="card">
        <h3>Build target</h3>
        <div class="row2">
          <div>
            <label>Build type</label>
            <select id="build_type">
              <option value="pi" selected>pi</option>
              <option value="pc">pc (reserved)</option>
            </select>
          </div>
          <div>
            <label>CPU bitrate</label>
            <select id="cpu_bitrate">
              <option value="64bit" selected>64bit</option>
              <option value="32bit">32bit</option>
            </select>
          </div>
        </div>
        <div class="hint">`target_bits` is computed and sent as “pi 64bit” / “pi 32bit”.</div>
      </div>

      <div class="card">
        <h3>User</h3>
        <label>Preset user</label>
        <select id="user_preset"></select>
        <label>Console username</label>
        <input id="user_name" placeholder="e.g. AirysDark" />
        <label>Console password</label>
        <input id="user_password" type="password" placeholder="e.g. ••••••••" />
        <div class="hint">Picking a preset fills these inputs — you can still edit them.</div>
      </div>
    </div>

    <!-- Wi-Fi + SSH -->
    <div class="grid" style="margin-top:16px">
      <div class="card">
        <h3>Wi-Fi</h3>
        <label>Preset Wi-Fi</label>
        <select id="wifi_preset"></select>
        <label>Wi-Fi SSID</label>
        <input id="wifi_ssid" placeholder="e.g. Raspbain" />
        <label>Wi-Fi password</label>
        <input id="wifi_password" type="password" placeholder="e.g. ••••••••" />
      </div>

      <div class="card">
        <h3>SSH</h3>
        <label>PermitRootLogin</label>
        <select id="ssh_prl">
          <option value="yes">yes</option>
          <option value="no">no</option>
          <option value="prohibit-password">prohibit-password</option>
        </select>

        <label>PasswordAuthentication</label>
        <select id="ssh_pa">
          <option value="yes">yes</option>
          <option value="no">no</option>
        </select>

        <label>PubkeyAuthentication</label>
        <select id="ssh_pk">
          <option value="yes">yes</option>
          <option value="no">no</option>
        </select>
      </div>
    </div>

    <!-- Network + Region -->
    <div class="grid" style="margin-top:16px">
      <div class="card">
        <h3>Network</h3>
        <div class="row2">
          <div>
            <label>Static IPv4</label>
            <input id="static_ip" placeholder="192.168.0.130" />
          </div>
          <div>
            <label>Gateway IPv4</label>
            <input id="gateway" placeholder="192.168.0.1" />
          </div>
        </div>
        <label>DNS servers</label>
        <input id="dns" placeholder="1.1.1.1;8.8.8.8" />
      </div>

      <div class="card">
        <h3>Region &amp; Locale</h3>
        <label>Wi-Fi country</label>
        <select id="wifi_country"></select>

        <label>Timezone</label>
        <select id="timezone"></select>

        <label>Keyboard layout</label>
        <select id="keyboard" onchange="toggleKeyboardCustom()"></select>

        <label id="kb_custom_label" style="display:none">Custom layout
          <input id="keyboard_custom" placeholder="e.g. us,intl" />
        </label>
      </div>
    </div>

    <!-- Build + progress + download -->
    <div class="card" style="margin-top:16px">
      <div class="row2">
        <div>
          <button class="btn" id="startBtn" type="button">Start build</button>
          <div class="footer-note">This page will dispatch the workflow, watch it finish, then fetch the artifact.</div>
        </div>
        <div>
          <button class="btn secondary" id="downloadBtn" type="button" style="display:none">Download OS (.zip)</button>
          <div id="downloadInfo" class="footer-note"></div>
        </div>
      </div>

      <div class="status" id="status">Idle.</div>

      <h3 style="margin-top:16px">workflow_dispatch JSON</h3>
      <div id="jsonOut" class="out">—</div>

      <h3 style="margin-top:16px">Diagnostics</h3>
      <div id="diag" class="out">—</div>
    </div>
  </div>

<script>
/* ------------------- helpers ------------------- */
function diag(msg){ const d=document.getElementById('diag'); d.textContent=(d.textContent==='—'?'':d.textContent+'\n')+msg; }
function setStatus(msg){ document.getElementById('status').textContent = msg; }
function targetBitsComputed(){
  return document.getElementById('build_type').value + ' ' + document.getElementById('cpu_bitrate').value;
}
function toggleKeyboardCustom(){
  const val = document.getElementById('keyboard').value;
  document.getElementById('kb_custom_label').style.display = (val === 'custom') ? 'block' : 'none';
}
function gatherInputs(){
  const inputs = {
    target_bits: targetBitsComputed(),
    user_name: document.getElementById('user_name').value,
    user_password: document.getElementById('user_password').value,
    wifi_ssid: document.getElementById('wifi_ssid').value,
    wifi_password: document.getElementById('wifi_password').value,
    ssh_permit_root_login: document.getElementById('ssh_prl').value,
    ssh_password_auth: document.getElementById('ssh_pa').value,
    ssh_pubkey_auth: document.getElementById('ssh_pk').value,
    static_ip: document.getElementById('static_ip').value,
    gateway: document.getElementById('gateway').value,
    dns: document.getElementById('dns').value,
    wifi_country: document.getElementById('wifi_country').value,
    timezone: document.getElementById('timezone').value,
    keyboard: document.getElementById('keyboard').value,
    keyboard_custom: document.getElementById('keyboard_custom').value
  };
  document.getElementById('jsonOut').textContent = JSON.stringify({ref:getRef(), inputs}, null, 2);
  return inputs;
}
function getOwner(){ return document.getElementById('owner').value.trim(); }
function getRepo(){ return document.getElementById('repo').value.trim(); }
function getWorkflowPath(){ return document.getElementById('workflow_path').value.trim(); }
function getRef(){ return document.getElementById('branch_ref').value.trim() || 'main'; }
function getToken(){ return document.getElementById('token').value.trim(); }

async function gh(method, path, token, body){
  const url = `https://api.github.com${path}`;
  const res = await fetch(url, {
    method,
    headers: {
      'Accept':'application/vnd.github+json',
      'X-GitHub-Api-Version':'2022-11-28',
      ...(token ? {'Authorization':`Bearer ${token}`} : {})
    },
    body: body ? JSON.stringify(body) : undefined
  });
  if (!res.ok){
    const text = await res.text().catch(()=> '');
    throw new Error(`${method} ${path} -> ${res.status} ${res.statusText} :: ${text}`);
  }
  if (res.status === 204) return null;
  return res.json();
}

/* ------------------- options.json loading ------------------- */
function fillSelect(id, arr, labelfn, valuefn, placeholder){
  const el = document.getElementById(id);
  el.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = ''; opt0.textContent = placeholder || '(select)';
  el.appendChild(opt0);
  arr.forEach((v,i)=>{
    const o = document.createElement('option');
    const label = labelfn ? labelfn(v,i) : String(v);
    const value = valuefn ? valuefn(v,i) : String(v);
    o.value = value; o.textContent = label; o.dataset.raw = JSON.stringify(v);
    el.appendChild(o);
  });
}
function onPresetChange(selId, setter){
  const sel = document.getElementById(selId);
  sel.addEventListener('change', ()=>{
    const opt = sel.options[sel.selectedIndex];
    if (!opt || !opt.dataset.raw) return;
    try { setter(JSON.parse(opt.dataset.raw)); } catch(e){}
  });
}
async function loadOptions(){
  const urls = [`config/options.json?v=${Date.now()}`, `./config/options.json?v=${Date.now()}`, `/config/options.json?v=${Date.now()}`];
  let js=null, fetched=false, lastErr='';
  for (const u of urls){
    try{ const r=await fetch(u,{cache:'no-store'}); if(r.ok){ js=await r.json(); fetched=true; diag(`Loaded ${u}`); break; } else lastErr=`${u} -> ${r.status}`; }catch(e){ lastErr = `${u} -> ${e}`; }
  }
  if(!fetched){ diag(`Could not load options.json (${lastErr}). Using built-in minimal lists.`); js={}; }

  const countries = (js.wifi_countries || js.country || ["AU","US","GB","NZ","CA"]);
  const zones     = (js.timezones || js.tz || ["Australia/Sydney","UTC","Europe/London","America/New_York"]);
  const kbs       = (js.keyboards || js.kbd || ["au","us","gb","us(intl)","custom"]);
  const users     = (js.users || [{name:"AirysDark", password:"Zombie1986X2"}]);
  const wifis     = (js.wifi  || [{ssid:"Raspbain",  password:"Zombie1986X2"}]);

  fillSelect('wifi_country', countries, v=>v, v=>v, '(Wi-Fi country)');
  fillSelect('timezone', zones, v=>v, v=>v, '(Timezone)');
  fillSelect('keyboard', kbs, v=>v, v=>v, '(Keyboard)');

  fillSelect('user_preset', users, u=>u.name, u=>u.name, '(no user preset)');
  fillSelect('wifi_preset', wifis, w=>w.ssid, w=>w.ssid, '(no Wi-Fi preset)');

  onPresetChange('user_preset', (u)=>{ user_name.value = u.name || ''; user_password.value = u.password || ''; });
  onPresetChange('wifi_preset', (w)=>{ wifi_ssid.value = w.ssid || ''; wifi_password.value = w.password || ''; });

  if(users.length){ const s=document.getElementById('user_preset'); s.selectedIndex=1; s.dispatchEvent(new Event('change')); }
  if(wifis.length){ const s=document.getElementById('wifi_preset'); s.selectedIndex=1; s.dispatchEvent(new Event('change')); }
  toggleKeyboardCustom();
}
loadOptions();

/* ------------------- build flow ------------------- */
async function dispatchWorkflow(){
  const owner=getOwner(), repo=getRepo(), token=getToken(), ref=getRef(), path=getWorkflowPath();
  if(!owner || !repo || !token){ throw new Error('Missing Owner, Repo or Token'); }
  // POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches
  const body = { ref, inputs: gatherInputs() };
  const wfPathEncoded = encodeURIComponent(path);
  await gh('POST', `/repos/${owner}/${repo}/actions/workflows/${wfPathEncoded}/dispatches`, token, body);
  return body;
}
async function findRecentRunId(afterISO){
  const owner=getOwner(), repo=getRepo(), token=getToken();
  // GET /repos/{owner}/{repo}/actions/runs?event=workflow_dispatch
  const list = await gh('GET', `/repos/${owner}/${repo}/actions/runs?event=workflow_dispatch&per_page=10`, token);
  const runs = (list.workflow_runs||[]).filter(r => new Date(r.created_at) >= new Date(afterISO));
  // pick the newest run for our branch
  const ref = getRef();
  const match = runs.find(r => r.head_branch === ref);
  return match ? match.id : null;
}
async function waitForRun(runId, onTick){
  const owner=getOwner(), repo=getRepo(), token=getToken();
  let delay=4000, maxDelay=15000;
  while(true){
    const run = await gh('GET', `/repos/${owner}/${repo}/actions/runs/${runId}`, token);
    onTick?.(run);
    if (run.status === 'completed'){
      if (run.conclusion !== 'success') throw new Error(`Run completed with conclusion=${run.conclusion}`);
      return run;
    }
    await new Promise(r=>setTimeout(r, delay));
    delay = Math.min(maxDelay, Math.floor(delay*1.25));
  }
}
async function getFirstArtifact(runId){
  const owner=getOwner(), repo=getRepo(), token=getToken();
  const arts = await gh('GET', `/repos/${owner}/${repo}/actions/runs/${runId}/artifacts`, token);
  if (!arts || !arts.artifacts || !arts.artifacts.length) throw new Error('No artifacts found on the run.');
  // prefer one named "Local-github-pi" if present
  const preferred = arts.artifacts.find(a => a.name.toLowerCase().includes('local-github'));
  return preferred || arts.artifacts[0];
}
async function downloadArtifactZip(artifact){
  const owner=getOwner(), repo=getRepo(), token=getToken();
  const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/artifacts/${artifact.id}/zip`, {
    headers: {
      'Accept':'application/vnd.github+json',
      'Authorization': `Bearer ${token}`,
      'X-GitHub-Api-Version':'2022-11-28'
    }
  });
  if(!res.ok){ throw new Error(`Download ZIP -> ${res.status} ${res.statusText}`); }
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  a.href=url; a.download = `${artifact.name || 'artifact'}-${ts}.zip`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* ------------------- wire up UI ------------------- */
document.getElementById('startBtn').addEventListener('click', async ()=>{
  try{
    document.getElementById('downloadBtn').style.display='none';
    document.getElementById('downloadInfo').textContent='';
    setStatus('Dispatching workflow…');
    const startedAt = new Date().toISOString();

    const payload = await dispatchWorkflow();
    diag('Dispatched with payload: ' + JSON.stringify(payload));

    setStatus('Looking for the run…');
    let runId=null;
    // poll to find run id
    for(let i=0;i<12;i++){
      runId = await findRecentRunId(startedAt);
      if (runId) break;
      await new Promise(r=>setTimeout(r, 3000));
    }
    if(!runId) throw new Error('Could not find the workflow run after dispatch.');

    setStatus(`Run #${runId} in progress… (this can take a while)`);
    await waitForRun(runId, (run)=>{
      setStatus(`Run #${run.id}: ${run.status} ${run.name} — ${run.head_branch}`);
    });

    setStatus(`Run succeeded. Collecting artifact…`);
    const art = await getFirstArtifact(runId);
    document.getElementById('downloadBtn').style.display='inline-flex';
    document.getElementById('downloadInfo').textContent = `Ready: ${art.name} (id: ${art.id})`;
    document.getElementById('downloadBtn').onclick = async ()=>{
      try{
        setStatus('Downloading artifact…');
        await downloadArtifactZip(art);
        setStatus('Download started.');
      }catch(e){
        setStatus('Download failed.'); diag('Download error: '+e.message);
      }
    };
  }catch(e){
    setStatus('Error. See diagnostics.'); diag('ERROR: ' + e.message);
  }
});
</script>
</body>
</html>
