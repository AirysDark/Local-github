<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Local-github Builder (dynamic from config/options.json)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { --bg:#0b0f14; --card:#121821; --muted:#a6b3c2; --text:#e8eef6; --accent:#5cc8ff; }
  * { box-sizing: border-box; }
  body { margin:0; font-family:system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
  .wrap { max-width:1100px; margin:24px auto; padding:0 16px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  .card { background:var(--card); border:1px solid #1f2733; border-radius:12px; padding:16px; }
  h1,h2,h3 { margin: 0 0 10px 0; }
  label { font-size:12px; color:var(--muted); display:block; margin-top:8px; }
  input, select, textarea, button { width:100%; padding:10px; border-radius:8px; border:1px solid #2a3342; background:#0e141c; color:var(--text); }
  small { color:var(--muted); }
  button { margin-top:12px; background:var(--accent); color:#001019; border:none; font-weight:600; cursor:pointer; }
  code { background:#0e141c; padding:2px 6px; border-radius:6px; border:1px solid #2a3342; }
  .out { white-space:pre-wrap; background:#0e141c; padding:12px; border-radius:8px; border:1px solid #2a3342; min-height:80px; }
  .two { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  .sep { margin: 16px 0; border-top:1px solid #1f2733; }
</style>
</head>
<body>
<div class="wrap">

  <h1>Local-github Builder</h1>

  <div class="row">
    <div class="card">
      <h3>Repository</h3>
      <label>Owner</label>
      <input id="owner" placeholder="e.g. chip">
      <label>Repo</label>
      <input id="repo" placeholder="e.g. Local-github">
      <label>Workflow file path</label>
      <input id="workflow" value=".github/workflows/build.yml">
      <label>Ref/branch</label>
      <input id="ref" value="main">
      <small>This page never sends the request. It only prints the JSON + a curl command you run in your terminal.</small>
    </div>

    <div class="card">
      <h3>Build Target</h3>
      <div class="two">
        <div>
          <label>Build type</label>
          <select id="build_type">
            <option value="pi" selected>pi</option>
            <option value="pc">pc (reserved)</option>
          </select>
        </div>
        <div>
          <label>CPU bitrate</label>
          <select id="cpu_bitrate">
            <option value="64bit" selected>64bit</option>
            <option value="32bit">32bit</option>
          </select>
        </div>
      </div>
      <label>target_bits</label>
      <input id="target_bits" value="auto" readonly>
      <small>Computed from Build type + CPU bitrate; the visible field stays “auto”.</small>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <h3>User</h3>
      <label>Preset user</label>
      <select id="user_preset"></select>
      <label>Console username</label>
      <input id="user_name" placeholder="e.g. AirysDark">
      <label>Console password</label>
      <input id="user_password" type="password" placeholder="e.g. Zombie1986X2">

      <div class="sep"></div>
      <h3>Wi-Fi</h3>
      <label>Preset Wi-Fi</label>
      <select id="wifi_preset"></select>
      <label>Wi-Fi SSID</label>
      <input id="wifi_ssid" placeholder="e.g. Raspbain">
      <label>Wi-Fi password</label>
      <input id="wifi_password" type="password" placeholder="e.g. YourWiFiPassword">
    </div>

    <div class="card">
      <h3>SSH</h3>
      <label>Preset SSH</label>
      <select id="ssh_preset"></select>
      <small>
        <div><code>PermitRootLogin</code>: <code>yes</code>=allow root; <code>prohibit-password</code>=keys only; <code>no</code>=disable</div>
      </small>
      <label>PermitRootLogin (override)</label>
      <input id="ssh_prl" placeholder="e.g. yes">
      <label>PasswordAuthentication (override)</label>
      <input id="ssh_pa" placeholder="e.g. yes">
      <label>PubkeyAuthentication (override)</label>
      <input id="ssh_pk" placeholder="e.g. yes">
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <h3>Networking</h3>
      <label>Preset static IPv4</label>
      <select id="net_preset"></select>
      <div class="two">
        <div>
          <label>Static IPv4</label>
          <input id="static_ip" placeholder="e.g. 192.168.0.8">
        </div>
        <div>
          <label>Gateway IPv4</label>
          <input id="gateway" placeholder="e.g. 192.168.0.1">
        </div>
      </div>
      <label>DNS servers</label>
      <input id="dns" placeholder="e.g. 1.1.1.1;8.8.8.8">
    </div>

    <div class="card">
      <h3>Region & Locale</h3>
      <label>Wi-Fi country</label>
      <select id="wifi_country"></select>
      <label>Timezone</label>
      <select id="timezone"></select>
      <label>Keyboard layout</label>
      <select id="keyboard" onchange="toggleKeyboardCustom()"></select>
      <label>Custom layout (only if “custom”)</label>
      <input id="keyboard_custom" placeholder="e.g. us,intl" style="display:none">
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <button id="buildBtn">Show build payload</button>
    <div style="margin-top:8px;">
      <label>Personal Access Token (optional — inserted into the curl below only)</label>
      <input id="token" type="password" placeholder="ghp_xxx (NOT sent by this page)">
    </div>

    <h3 style="margin-top:16px">workflow_dispatch JSON</h3>
    <div id="jsonOut" class="out">Click “Show build payload”.</div>

    <h3 style="margin-top:16px">curl command (copy & run locally)</h3>
    <div id="curlOut" class="out">—</div>

    <h3 style="margin-top:16px">Repo details used</h3>
    <div id="repoOut" class="out">—</div>
  </div>

</div>

<script>
function targetBitsComputed() {
  return document.getElementById('build_type').value + ' ' + document.getElementById('cpu_bitrate').value;
}
function toggleKeyboardCustom(){
  const kb = document.getElementById('keyboard').value;
  document.getElementById('keyboard_custom').style.display = (kb === 'custom') ? 'block' : 'none';
}
function gatherInputs() {
  return {
    target_bits: targetBitsComputed(),
    user_name: document.getElementById('user_name').value,
    user_password: document.getElementById('user_password').value,
    wifi_ssid: document.getElementById('wifi_ssid').value,
    wifi_password: document.getElementById('wifi_password').value,
    ssh_permit_root_login: document.getElementById('ssh_prl').value,
    ssh_password_auth: document.getElementById('ssh_pa').value,
    ssh_pubkey_auth: document.getElementById('ssh_pk').value,
    static_ip: document.getElementById('static_ip').value,
    gateway: document.getElementById('gateway').value,
    dns: document.getElementById('dns').value,
    wifi_country: document.getElementById('wifi_country').value,
    timezone: document.getElementById('timezone').value,
    keyboard: document.getElementById('keyboard').value,
    keyboard_custom: document.getElementById('keyboard_custom').value
  };
}
function showPayload() {
  const owner = (document.getElementById('owner').value || '').trim();
  const repo  = (document.getElementById('repo').value  || '').trim();
  const wf    = (document.getElementById('workflow').value || '.github/workflows/build.yml').trim();
  const ref   = (document.getElementById('ref').value || 'main').trim();
  const token = (document.getElementById('token').value || '').trim();

  if (!owner || !repo) {
    document.getElementById('jsonOut').textContent = 'Owner and repo are required.';
    document.getElementById('curlOut').textContent = '—';
    document.getElementById('repoOut').textContent = '—';
    return;
  }

  const body = { ref, inputs: gatherInputs() };
  const url = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/${encodeURIComponent(wf)}/dispatches`;

  document.getElementById('jsonOut').textContent = JSON.stringify(body, null, 2);
  document.getElementById('repoOut').textContent = JSON.stringify({ url, owner, repo, workflow: wf, ref }, null, 2);

  const authHeader = token ? `  -H "Authorization: Bearer ${token}" \\` : '  # -H "Authorization: Bearer <TOKEN>" \\';
  const curl = [
    'curl -s -X POST \\',
    '  -H "Accept: application/vnd.github+json" \\',
    '  -H "X-GitHub-Api-Version: 2022-11-28" \\',
    authHeader,
    `  https://api.github.com/repos/${owner}/${repo}/actions/workflows/${encodeURIComponent(wf)}/dispatches \\`,
    "  -d '" + JSON.stringify(body).replace(/'/g, "'\"'\"'") + "'"
  ].join("\n");
  document.getElementById('curlOut').textContent = curl;
}

function fillSelect(id, arr, labelfn, valuefn, placeholder) {
  const sel = document.getElementById(id);
  sel.innerHTML = "";
  const opt0 = document.createElement('option');
  opt0.value = ""; opt0.textContent = placeholder || "(select)";
  sel.appendChild(opt0);
  arr.forEach((it, idx) => {
    const o = document.createElement('option');
    const label = labelfn ? labelfn(it, idx) : String(it);
    const value = valuefn ? valuefn(it, idx) : String(it);
    o.value = value; o.textContent = label;
    o.dataset.raw = JSON.stringify(it);
    sel.appendChild(o);
  });
}

function applyPreset(selId, setter){
  const sel = document.getElementById(selId);
  const opt = sel.options[sel.selectedIndex];
  if (!opt || !opt.dataset.raw) return;
  try {
    const obj = JSON.parse(opt.dataset.raw);
    setter(obj);
  } catch(e) {}
}

async function loadOptions(){
  // Looks for docs/config/options.json (same folder structure when deployed via Pages)
  const urls = ['config/options.json', './config/options.json', '/config/options.json'];
  let js = null;
  for (const u of urls) {
    try {
      const r = await fetch(u, {cache:'no-store'});
      if (r.ok) { js = await r.json(); break; }
    } catch (e) {}
  }
  if (!js) {
    document.getElementById('jsonOut').textContent = 'Could not load config/options.json';
    return;
  }

  // Region & locale (support both alias keys)
  const countries = js.wifi_countries || js.country || [];
  const timezones = js.timezones || js.tz || [];
  const keyboards = js.keyboards || js.kbd || [];

  fillSelect('wifi_country', countries, (v)=>v, (v)=>v, '(Wi-Fi country)');
  fillSelect('timezone', timezones, (v)=>v, (v)=>v, '(Timezone)');
  fillSelect('keyboard', keyboards, (v)=>v, (v)=>v, '(Keyboard)');

  // Presets (optional in JSON)
  fillSelect('user_preset', js.users || [], (u)=>u.name, (u)=>u.name, '(no user preset)');
  fillSelect('wifi_preset', js.wifi || [], (w)=>w.ssid, (w)=>w.ssid, '(no Wi-Fi preset)');
  fillSelect('ssh_preset',  js.ssh  || [], (s)=> (s.label || `${s.permit_root_login}:${s.password_auth}:${s.pubkey_auth}`), (s)=> (s.label || `${s.permit_root_login}:${s.password_auth}:${s.pubkey_auth}`), '(no SSH preset)');
  fillSelect('net_preset',  js.net  || js.net_ipv4 || [], (n)=> `${n.ip} → ${n.gateway} (${n.dns})`, (n)=> n.ip, '(no IP preset)');

  // Auto-apply first preset if present
  if ((js.users||[]).length) {
    document.getElementById('user_preset').selectedIndex = 1;
    applyPreset('user_preset', (u)=>{
      document.getElementById('user_name').value = u.name || '';
      document.getElementById('user_password').value = u.password || '';
    });
  }
  if ((js.wifi||[]).length) {
    document.getElementById('wifi_preset').selectedIndex = 1;
    applyPreset('wifi_preset', (w)=>{
      document.getElementById('wifi_ssid').value = w.ssid || '';
      document.getElementById('wifi_password').value = w.password || '';
    });
  }
  if ((js.ssh||[]).length) {
    document.getElementById('ssh_preset').selectedIndex = 1;
    applyPreset('ssh_preset', (s)=>{
      document.getElementById('ssh_prl').value = s.permit_root_login || '';
      document.getElementById('ssh_pa').value  = s.password_auth || '';
      document.getElementById('ssh_pk').value  = s.pubkey_auth || '';
    });
  }
  const nets = js.net || js.net_ipv4 || [];
  if (nets.length) {
    document.getElementById('net_preset').selectedIndex = 1;
    applyPreset('net_preset', (n)=>{
      document.getElementById('static_ip').value = n.ip || '';
      document.getElementById('gateway').value   = n.gateway || '';
      document.getElementById('dns').value       = n.dns || '';
    });
  }

  // Change handlers — picking a preset fills the fields but you can still edit
  document.getElementById('user_preset').addEventListener('change', ()=>applyPreset('user_preset',(u)=>{
    document.getElementById('user_name').value = u.name || '';
    document.getElementById('user_password').value = u.password || '';
  }));
  document.getElementById('wifi_preset').addEventListener('change', ()=>applyPreset('wifi_preset',(w)=>{
    document.getElementById('wifi_ssid').value = w.ssid || '';
    document.getElementById('wifi_password').value = w.password || '';
  }));
  document.getElementById('ssh_preset').addEventListener('change', ()=>applyPreset('ssh_preset',(s)=>{
    document.getElementById('ssh_prl').value = s.permit_root_login || '';
    document.getElementById('ssh_pa').value  = s.password_auth || '';
    document.getElementById('ssh_pk').value  = s.pubkey_auth || '';
  }));
  document.getElementById('net_preset').addEventListener('change', ()=>applyPreset('net_preset',(n)=>{
    document.getElementById('static_ip').value = n.ip || '';
    document.getElementById('gateway').value   = n.gateway || '';
    document.getElementById('dns').value       = n.dns || '';
  }));
}

document.getElementById('buildBtn').addEventListener('click', function(e){
  e.preventDefault();
  document.getElementById('target_bits').value = 'auto'; // keep visible as "auto"
  showPayload();
});

loadOptions();
</script>
</body>
</html>