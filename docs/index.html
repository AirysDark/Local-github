<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Local-github Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind for a nicer UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { @apply bg-white/80 backdrop-blur rounded-2xl shadow p-6 border border-gray-200; }
    .grid2 { @apply grid grid-cols-1 md:grid-cols-2 gap-4; }
    .label { @apply block text-sm font-medium text-gray-700 mb-1; }
    .input, select, textarea { @apply w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500; }
    .hint { @apply text-xs text-gray-500 mt-1; }
    .btn { @apply inline-flex items-center justify-center rounded-xl px-4 py-2 font-medium bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50; }
    .btn-outline { @apply inline-flex items-center justify-center rounded-xl px-4 py-2 font-medium border border-gray-300 bg-white hover:bg-gray-50; }
    .section-title { @apply text-lg font-semibold mb-4; }
    .badge { @apply inline-block text-xs font-semibold bg-gray-100 text-gray-700 px-2 py-1 rounded; }
    .hr { @apply my-6 border-t border-gray-200; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen text-slate-900">
  <div class="max-w-5xl mx-auto p-6 md:p-10">
    <header class="mb-8">
      <h1 class="text-3xl font-bold">Local-github Builder</h1>
      <p class="text-gray-600">Load presets from <span class="badge">/config/*.json</span>, fill options, and build your inputs payload.</p>
    </header>

    <!-- Status -->
    <div id="status" class="card mb-6">
      <div class="flex items-center gap-3">
        <div class="w-2.5 h-2.5 rounded-full bg-amber-500 animate-pulse" id="statusDot"></div>
        <div class="text-sm" id="statusText">Loading presets?</div>
      </div>
    </div>

    <!-- Build section -->
    <div class="card mb-6">
      <div class="section-title">Build Target</div>
      <div class="grid2">
        <div>
          <label class="label" for="build_type">Build type</label>
          <select id="build_type"></select>
          <div class="hint">Choose the platform (Pi, Jetson, x86, Android, etc.).</div>
        </div>
        <div>
          <label class="label" for="cpu_bitrate">CPU bit-rate</label>
          <select id="cpu_bitrate"></select>
          <div class="hint">32bit or 64bit. For Pi + bitrate we also compute <span class="badge">target_bits</span> for the workflow.</div>
        </div>
      </div>
    </div>

    <!-- Accounts & Wi-Fi -->
    <div class="card mb-6">
      <div class="section-title">Console User & Wi-Fi</div>
      <div class="grid2">
        <div>
          <label class="label" for="user_name">Console username</label>
          <input id="user_name" class="input" placeholder="e.g. AirysDark" />
        </div>
        <div>
          <label class="label" for="user_password">Console password</label>
          <input id="user_password" type="password" class="input" placeholder="????????" />
        </div>
        <div>
          <label class="label" for="wifi_ssid">Wi-Fi SSID</label>
          <input id="wifi_ssid" class="input" placeholder="e.g. Raspbain" />
        </div>
        <div>
          <label class="label" for="wifi_password">Wi-Fi password</label>
          <input id="wifi_password" type="password" class="input" placeholder="????????" />
        </div>
      </div>
    </div>

    <!-- SSH -->
    <div class="card mb-6">
      <div class="section-title">SSH (sshd_config)</div>
      <div class="grid2">
        <div>
          <label class="label" for="ssh_permit_root_login">PermitRootLogin</label>
          <select id="ssh_permit_root_login">
            <option value="yes">yes</option>
            <option value="prohibit-password">prohibit-password</option>
            <option value="no">no</option>
          </select>
          <div class="hint">Allows SSH login as root. <b>yes</b> enables it; <b>prohibit-password</b> disables password but allows keys; <b>no</b> disables root SSH entirely.</div>
        </div>
        <div>
          <label class="label" for="ssh_password_auth">PasswordAuthentication</label>
          <select id="ssh_password_auth">
            <option value="yes">yes</option>
            <option value="no">no</option>
          </select>
          <div class="hint">Enable/disable password logins for SSH.</div>
        </div>
        <div>
          <label class="label" for="ssh_pubkey_auth">PubkeyAuthentication</label>
          <select id="ssh_pubkey_auth">
            <option value="yes">yes</option>
            <option value="no">no</option>
          </select>
          <div class="hint">Enable/disable public key authentication.</div>
        </div>
      </div>
    </div>

    <!-- Networking -->
    <div class="card mb-6">
      <div class="section-title">Static IPv4</div>
      <div class="grid2">
        <div>
          <label class="label" for="static_ip">Device IPv4</label>
          <input id="static_ip" class="input" placeholder="e.g. 192.168.0.8" />
        </div>
        <div>
          <label class="label" for="gateway">Gateway IPv4</label>
          <input id="gateway" class="input" placeholder="e.g. 192.168.0.1" />
        </div>
        <div>
          <label class="label" for="dns">DNS servers</label>
          <input id="dns" class="input" placeholder="e.g. 1.1.1.1;8.8.8.8" />
          <div class="hint">Semicolon separated.</div>
        </div>
      </div>
    </div>

    <!-- Region & Locale -->
    <div class="card mb-6">
      <div class="section-title">Region &amp; Locale</div>
      <div class="grid2">
        <div>
          <label class="label" for="wifi_country">Wi-Fi country</label>
          <select id="wifi_country"></select>
        </div>
        <div>
          <label class="label" for="timezone">Timezone</label>
          <select id="timezone"></select>
        </div>
        <div>
          <label class="label" for="keyboard">Keyboard layout</label>
          <select id="keyboard"></select>
          <div class="hint">Choose <b>custom</b> to enter an arbitrary XKB layout variant below.</div>
        </div>
        <div id="kbdCustomWrap" class="hidden">
          <label class="label" for="keyboard_custom">Custom keyboard layout</label>
          <input id="keyboard_custom" class="input" placeholder="e.g. us,intl" />
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="card">
      <div class="section-title">Build &amp; Export</div>
      <div class="flex flex-wrap gap-3 mb-4">
        <button id="btnPreview" class="btn">Preview payload</button>
        <button id="btnDownload" class="btn-outline">Download inputs.json</button>

        <!-- Optional: API dispatch (kept but collapsed). Expand if you want to trigger GitHub directly -->
        <details>
          <summary class="cursor-pointer select-none">Trigger workflow (optional)</summary>
          <div class="grid2 mt-4">
            <div>
              <label class="label" for="owner">Owner</label>
              <input id="owner" class="input" placeholder="e.g. AirysDark" />
            </div>
            <div>
              <label class="label" for="repo">Repo</label>
              <input id="repo" class="input" placeholder="e.g. Local-github" />
            </div>
            <div>
              <label class="label" for="workflowPath">Workflow path</label>
              <input id="workflowPath" class="input" value=".github/workflows/build.yml" />
            </div>
            <div>
              <label class="label" for="ref">Ref/branch</label>
              <input id="ref" class="input" value="main" />
            </div>
            <div class="md:col-span-2">
              <label class="label" for="token">GitHub token (repo scope)</label>
              <input id="token" type="password" class="input" placeholder="ghp_xxx or fine-grained token" />
              <div class="hint">Your browser calls the GitHub API directly. Token is only used client-side.</div>
            </div>
          </div>
          <div class="mt-3 flex gap-3">
            <button id="btnDispatchMany" class="btn">Dispatch (current many-input workflow)</button>
            <button id="btnDispatchBlob" class="btn-outline">Dispatch (compact <span class="mono">config_blob</span>)</button>
          </div>
          <p class="hint mt-2">Note: GitHub?s REST limit is <b>max 10 inputs</b>. If your workflow defines more than 10, use the <b>config_blob</b> model (update your workflow to accept a single JSON string and parse it inside).</p>
        </details>
      </div>

      <pre id="preview" class="mono text-xs bg-slate-900 text-slate-100 rounded-xl p-4 overflow-x-auto"></pre>
    </div>
  </div>

  <script>
    const cfgPaths = {
      defaults: "config/defaults.json",
      build_types: "config/build_types.json",
      cpu_bitrates: "config/cpu_bitrates.json",
      wifi_countries: "config/wifi_countries.json",
      timezones: "config/tz.json",
      keyboards: "config/kbd.json"
    };

    const els = {
      statusDot: document.getElementById("statusDot"),
      statusText: document.getElementById("statusText"),
      build_type: document.getElementById("build_type"),
      cpu_bitrate: document.getElementById("cpu_bitrate"),
      user_name: document.getElementById("user_name"),
      user_password: document.getElementById("user_password"),
      wifi_ssid: document.getElementById("wifi_ssid"),
      wifi_password: document.getElementById("wifi_password"),
      ssh_permit_root_login: document.getElementById("ssh_permit_root_login"),
      ssh_password_auth: document.getElementById("ssh_password_auth"),
      ssh_pubkey_auth: document.getElementById("ssh_pubkey_auth"),
      static_ip: document.getElementById("static_ip"),
      gateway: document.getElementById("gateway"),
      dns: document.getElementById("dns"),
      wifi_country: document.getElementById("wifi_country"),
      timezone: document.getElementById("timezone"),
      keyboard: document.getElementById("keyboard"),
      keyboard_custom: document.getElementById("keyboard_custom"),
      kbdCustomWrap: document.getElementById("kbdCustomWrap"),
      preview: document.getElementById("preview"),
      // dispatch bits
      owner: document.getElementById("owner"),
      repo: document.getElementById("repo"),
      token: document.getElementById("token"),
      workflowPath: document.getElementById("workflowPath"),
      ref: document.getElementById("ref"),
      // buttons
      btnPreview: document.getElementById("btnPreview"),
      btnDownload: document.getElementById("btnDownload"),
      btnDispatchMany: document.getElementById("btnDispatchMany"),
      btnDispatchBlob: document.getElementById("btnDispatchBlob")
    };

    function setStatus(ok, msg) {
      els.statusDot.className = "w-2.5 h-2.5 rounded-full " + (ok ? "bg-emerald-500" : "bg-amber-500 animate-pulse");
      els.statusText.textContent = msg;
    }

    async function fetchJSON(path) {
      const cacheBust = `?v=${Date.now()}`;
      const res = await fetch(path + cacheBust);
      if (!res.ok) throw new Error(`${path} -> ${res.status}`);
      return res.json();
    }

    function fillSelect(el, arr, { placeholder=null, selected=null } = {}) {
      el.innerHTML = "";
      if (placeholder) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = placeholder;
        el.appendChild(opt);
      }
      for (const v of arr) {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        el.appendChild(opt);
      }
      if (selected != null) el.value = selected;
    }

    function computeTargetBits(build_type, cpu_bitrate) {
      // For Pi targets, the workflow expects "pi 64bit" or "pi 32bit"
      // Otherwise we still compose a readable target string.
      const base = build_type.startsWith("pi") ? "pi" : build_type;
      return `${base} ${cpu_bitrate}`;
    }

    function currentPayload() {
      const keyboard = els.keyboard.value;
      const kbFinal = (keyboard === "custom" && els.keyboard_custom.value.trim())
        ? els.keyboard_custom.value.trim()
        : keyboard;

      const build_type = els.build_type.value;
      const cpu_bitrate = els.cpu_bitrate.value;
      const target_bits = computeTargetBits(build_type, cpu_bitrate);

      return {
        // Build
        build_type,
        cpu_bitrate,
        target_bits,
        // User & Wi-Fi
        user_name: els.user_name.value,
        user_password: els.user_password.value,
        wifi_ssid: els.wifi_ssid.value,
        wifi_password: els.wifi_password.value,
        // SSH
        ssh_permit_root_login: els.ssh_permit_root_login.value,
        ssh_password_auth: els.ssh_password_auth.value,
        ssh_pubkey_auth: els.ssh_pubkey_auth.value,
        // Net
        static_ip: els.static_ip.value,
        gateway: els.gateway.value,
        dns: els.dns.value,
        // Region
        wifi_country: els.wifi_country.value,
        timezone: els.timezone.value,
        keyboard: kbFinal,
        keyboard_custom: (keyboard === "custom" ? els.keyboard_custom.value : "")
      };
    }

    function downloadJSON(obj, filename) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function dispatchWorkflowManyInputs(owner, repo, workflowPath, ref, token, inputs) {
      const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/actions/workflows/${encodeURIComponent(workflowPath)}/dispatches`;
      const body = { ref, inputs };
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Accept": "application/vnd.github+json",
          "X-GitHub-Api-Version": "2022-11-28",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`Dispatch failed ${res.status}: ${txt}`);
      }
      return true;
    }

    async function dispatchWorkflowBlob(owner, repo, workflowPath, ref, token, inputs) {
      // For workflows that accept only:
      //   inputs: { target_bits: "...", config_blob: "<base64 json>" }
      const compact = { ...inputs };
      const { target_bits } = compact;
      delete compact.target_bits;
      const blob = btoa(unescape(encodeURIComponent(JSON.stringify(compact))));
      const minimal = { target_bits, config_blob: blob };

      return dispatchWorkflowManyInputs(owner, repo, workflowPath, ref, token, minimal);
    }

    function wireKeyboardCustomToggle() {
      const update = () => {
        if (els.keyboard.value === "custom") {
          els.kbdCustomWrap.classList.remove("hidden");
        } else {
          els.kbdCustomWrap.classList.add("hidden");
        }
      };
      els.keyboard.addEventListener("change", update);
      update();
    }

    async function init() {
      try {
        const [defaults, build_types, cpu_bitrates, countries, timezones, keyboards] = await Promise.all([
          fetchJSON(cfgPaths.defaults),
          fetchJSON(cfgPaths.build_types),
          fetchJSON(cfgPaths.cpu_bitrates),
          fetchJSON(cfgPaths.wifi_countries),
          fetchJSON(cfgPaths.timezones),
          fetchJSON(cfgPaths.keyboards)
        ]);

        fillSelect(els.build_type, build_types, { selected: defaults.build_type });
        fillSelect(els.cpu_bitrate, cpu_bitrates, { selected: defaults.cpu_bitrate });

        // User & Wi-Fi defaults
        els.user_name.value = defaults.user_name || "";
        els.user_password.value = defaults.user_password || "";
        els.wifi_ssid.value = defaults.wifi_ssid || "";
        els.wifi_password.value = defaults.wifi_password || "";

        // SSH defaults
        els.ssh_permit_root_login.value = defaults.ssh_permit_root_login || "prohibit-password";
        els.ssh_password_auth.value = defaults.ssh_password_auth || "yes";
        els.ssh_pubkey_auth.value = defaults.ssh_pubkey_auth || "yes";

        // Net defaults
        els.static_ip.value = defaults.static_ip || "";
        els.gateway.value = defaults.gateway || "";
        els.dns.value = defaults.dns || "";

        // Region & locale
        fillSelect(els.wifi_country, countries, { selected: defaults.wifi_country || "AU" });
        fillSelect(els.timezone, timezones, { selected: defaults.timezone || "UTC" });
        fillSelect(els.keyboard, keyboards, { selected: defaults.keyboard || "us" });
        if (defaults.keyboard === "custom") {
          els.keyboard_custom.value = defaults.keyboard_custom || "";
        }
        wireKeyboardCustomToggle();

        setStatus(true, "Presets loaded.");
      } catch (e) {
        console.error(e);
        setStatus(false, "Failed to load some config files. Check /config/*.json paths.");
      }

      // Buttons
      els.btnPreview.addEventListener("click", () => {
        const payload = currentPayload();
        els.preview.textContent = JSON.stringify(payload, null, 2);
      });

      els.btnDownload.addEventListener("click", () => {
        const payload = currentPayload();
        downloadJSON(payload, "inputs.json");
      });

      els.btnDispatchMany.addEventListener("click", async () => {
        const owner = els.owner.value.trim();
        const repo = els.repo.value.trim();
        const path = els.workflowPath.value.trim();
        const ref = els.ref.value.trim();
        const token = els.token.value.trim();
        const payload = currentPayload();
        els.preview.textContent = "Dispatching?";
        try {
          await dispatchWorkflowManyInputs(owner, repo, path, ref, token, payload);
          els.preview.textContent = "? Dispatched with many inputs.\nCheck Actions ? Workflows for progress.";
        } catch (e) {
          els.preview.textContent = `? ${e.message}`;
        }
      });

      els.btnDispatchBlob.addEventListener("click", async () => {
        const owner = els.owner.value.trim();
        const repo = els.repo.value.trim();
        const path = els.workflowPath.value.trim();
        const ref = els.ref.value.trim();
        const token = els.token.value.trim();
        const payload = currentPayload();
        els.preview.textContent = "Dispatching (compact)?";
        try {
          await dispatchWorkflowBlob(owner, repo, path, ref, token, payload);
          els.preview.textContent = "? Dispatched with compact config_blob.\nCheck Actions ? Workflows for progress.";
        } catch (e) {
          els.preview.textContent = `? ${e.message}`;
        }
      });
    }

    init();
  </script>
</body>
</html>
